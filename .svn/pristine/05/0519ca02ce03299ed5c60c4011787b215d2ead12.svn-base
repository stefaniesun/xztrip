package xyz.svc.wechat.imp;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.hibernate.Query;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import xyz.dao.CommonDao;
import xyz.filter.ReturnUtil;
import xyz.model.member.WeixinUserInfo;
import xyz.svc.wechat.WeixinUserInfoSvc;
import xyz.util.WeixinUtil;

@Service
public class WeixinUserInfoSvcImp implements WeixinUserInfoSvc {

	@Autowired
	CommonDao commonDao;
	
	@Override
	public Map<String, Object> queryWeixinUserInfoList(int offset,int pagesize,String nickname) {
		String hql = "from WeixinUserInfo where 1=1";
		if(nickname != null && !"".equals(nickname)){
			hql += " and nickname like '%"+nickname+"%'";
		}
		
		String countHql = "select count(iidd)"+hql;
		Query countQuery = commonDao.getQuery(countHql);
		Number countNum = (Number) countQuery.uniqueResult();
		int count = countNum==null?0:countNum.intValue();
		
		Query query = commonDao.getQuery(hql);
		query.setMaxResults(pagesize);
		query.setFirstResult(offset);
		@SuppressWarnings("unchecked")
		List<WeixinUserInfo> weixinUserInfo = query.list();
		
		Map<String,Object> mapContent = new HashMap<String,Object>();
		mapContent.put("total", count);
		mapContent.put("rows", weixinUserInfo);
		return ReturnUtil.returnMap(1, mapContent);
	}

	@Override
	public Map<String, Object> getWeixinUserInfo(String openid,String account) {
		if(openid == null && account == null){
			return ReturnUtil.returnMap(0, "缺少参数！");
		}
		
		WeixinUserInfo  weixinUserInfo;
		if(openid != null && !"".equals(openid)){
			weixinUserInfo = (WeixinUserInfo)commonDao.getObjectByUniqueCode("WeixinUserInfo", "openid", openid);
		}else{
			weixinUserInfo = (WeixinUserInfo)commonDao.getObjectByUniqueCode("WeixinUserInfo", "account", account);
		}
		
		if(weixinUserInfo == null){
			return ReturnUtil.returnMap(0, "该用户不存在！");
		}
		return ReturnUtil.returnMap(1, weixinUserInfo);
	}

	@Override
	public Map<String, Object> addWeixinUser(WeixinUserInfo weixinUserInfo) {
		if(weixinUserInfo == null){
			return ReturnUtil.returnMap(0, "缺少参数！");
		}
		
		WeixinUserInfo weixinUser = (WeixinUserInfo)commonDao.getObjectByUniqueCode("WeixinUserInfo", "openid", weixinUserInfo.getOpenid());
		if(weixinUser != null){
			weixinUser.setSubscribe(weixinUserInfo.getSubscribe());
			weixinUser.setSubscribe_time(weixinUserInfo.getSubscribe_time());
			weixinUser.setNickname(weixinUserInfo.getNickname());
			weixinUser.setSex(weixinUserInfo.getSex());
			weixinUser.setLanguage(weixinUserInfo.getLanguage());
			weixinUser.setCity(weixinUserInfo.getCity());
			weixinUser.setProvince(weixinUserInfo.getProvince());
			weixinUser.setCountry(weixinUserInfo.getCountry());
			weixinUser.setHeadimgurl(weixinUserInfo.getHeadimgurl());
			commonDao.save(weixinUser);
		}else{
			commonDao.save(weixinUserInfo);
		}
		return ReturnUtil.returnMap(1, null);
	}

	@Override
	public Map<String,Object> editWeixinUser(String openid,String account,String linkPhone){
		if(openid == null && "".equals(openid)){
			return ReturnUtil.returnMap(0, "缺少参数！");
		}
		
		WeixinUserInfo weixinUserInfo = (WeixinUserInfo)commonDao.getObjectByUniqueCode("WeixinUserInfo", "openid", openid);
		if(weixinUserInfo != null){
			if(account != null && !"".equals(account)){		//保存erp账号
				WeixinUserInfo wui = (WeixinUserInfo)commonDao.getObjectByUniqueCode("WeixinUserInfo", "account", account);
				if(wui != null){
//					wui.setAccount("");
					commonDao.update(wui);
				}
//				weixinUserInfo.setAccount(account);
			}else{	//取消关注
				weixinUserInfo.setSubscribe("0");
			}
			
			if(linkPhone != null){
				weixinUserInfo.setLinkPhone(linkPhone);
			}
			
			commonDao.update(weixinUserInfo);
			return ReturnUtil.returnMap(1, null);
		}else{
			return ReturnUtil.returnMap(0, "用户不存在！");
		}
	}

	@Override
	public Map<String, Object> addOrUpdateWeixinUser(
			Map<String, Object> userInfo) {
		if(userInfo.isEmpty()){
			return ReturnUtil.returnMap(0, null);
		}
		String openid = WeixinUtil.getString(userInfo,"openid");
		WeixinUserInfo weixinUserInfo = (WeixinUserInfo)commonDao.getObjectByUniqueCode("WeixinUserInfo", "openid", openid);
		if(weixinUserInfo==null){
			weixinUserInfo = new WeixinUserInfo();
			weixinUserInfo.setCity(WeixinUtil.getString(userInfo,"city"));
			weixinUserInfo.setCountry(WeixinUtil.getString(userInfo,"country"));
			weixinUserInfo.setGroupid(WeixinUtil.getString(userInfo,"groupid"));
			weixinUserInfo.setHeadimgurl(WeixinUtil.getString(userInfo,"headimgurl"));
			weixinUserInfo.setLanguage(WeixinUtil.getString(userInfo,"language"));
			weixinUserInfo.setNickname(WeixinUtil.getString(userInfo,"nickname"));
			weixinUserInfo.setOpenid(WeixinUtil.getString(userInfo,"openid"));
			weixinUserInfo.setProvince(WeixinUtil.getString(userInfo,"province"));
			weixinUserInfo.setRemark(WeixinUtil.getString(userInfo,"remark"));
			weixinUserInfo.setSex(WeixinUtil.getString(userInfo,"sex"));
			weixinUserInfo.setSubscribe(WeixinUtil.getString(userInfo,"subscribe"));
			weixinUserInfo.setSubscribe_time(WeixinUtil.getString(userInfo,"subscribe_time"));
			weixinUserInfo.setUnionid(WeixinUtil.getString(userInfo,"unionid"));
			commonDao.save(weixinUserInfo);
		}else{
			weixinUserInfo.setCity(WeixinUtil.getString(userInfo,"city"));
			weixinUserInfo.setCountry(WeixinUtil.getString(userInfo,"country"));
			weixinUserInfo.setGroupid(WeixinUtil.getString(userInfo,"groupid"));
			weixinUserInfo.setHeadimgurl(WeixinUtil.getString(userInfo,"headimgurl"));
			weixinUserInfo.setLanguage(WeixinUtil.getString(userInfo,"language"));
			weixinUserInfo.setNickname(WeixinUtil.getString(userInfo,"nickname"));
			weixinUserInfo.setOpenid(WeixinUtil.getString(userInfo,"openid"));
			weixinUserInfo.setProvince(WeixinUtil.getString(userInfo,"province"));
			weixinUserInfo.setRemark(WeixinUtil.getString(userInfo,"remark"));
			weixinUserInfo.setSex(WeixinUtil.getString(userInfo,"sex"));
			weixinUserInfo.setSubscribe(WeixinUtil.getString(userInfo,"subscribe"));
			weixinUserInfo.setSubscribe_time(WeixinUtil.getString(userInfo,"subscribe_time"));
			weixinUserInfo.setUnionid(WeixinUtil.getString(userInfo,"unionid"));
			commonDao.update(weixinUserInfo);
		}
		
		return ReturnUtil.returnMap(1, null);
	}
}
